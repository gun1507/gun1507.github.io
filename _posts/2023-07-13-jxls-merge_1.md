---
title: Jxls merge cell ë™ì  ë³‘í•© êµ¬í˜„(each-merge, each-merge-single)
date: 2023-07-13 14:20:00 +0900
lastmod: 2023-07-13 14:20:00 +0900
categories: [Java, Jxls]
tags: [Java, Jxls, Poi, Excel, chirpy]
description: Java, Jxls, Poi, Excel, ì—‘ì…€, ë™ì  ë³‘í•©, each-merge, each-merge-single, excel auto merge
toc: true
toc_sticky: true
toc_label: ëª©ì°¨
math: true
mermaid: true
---

<h1> Jxls </h1>
---
Jxls ëŠ” ë¯¸ë¦¬ ì—‘ì…€ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ë‘ê³  ë°ì´í„°ë¥¼ í…œí”Œë¦¿ì— ë°”ì¸ë”©í•œ í›„ ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ë°›ê²Œë” ì²˜ë¦¬í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.\
ì—‘ì…€ í…œí”Œë¦¿ì— ë°ì´í„° ë°”ì¸ë”© í•  ë•Œì˜ ë¬¸ë²•ì€ Jstl ê³¼ ë§¤ìš° ìœ ì‚¬í•˜ê¸° ë•Œë¬¸ì— Jstl ì„ ë‹¤ë¤„ë´¤ë‹¤ë©´ ì¡°ê¸ˆ ë” ì ‘ê·¼í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.

<br>

> Jxls ë¥¼ ì‚¬ìš©í•˜ë©° ê°€ì¥ ì–´ë ¤ì› ë˜ ë¶€ë¶„ì€ ë™ì  ë³‘í•© ì´ì—ˆìŠµë‹ˆë‹¤. ë•Œë¬¸ì— ë‘ custom í•©ìˆ˜ê°€ ë‚˜ì˜¤ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\
> `each-merge` ì™€ `each-merge-single` ì€ íŠ¹ì§•ì´ ì„œë¡œ ë‹¤ë¥¸ í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì— ê°ê° ì„¤ëª…ì„ í•˜ê² ìŠµë‹ˆë‹¤.

<br>

<h1> each-merge </h1>
---
`each-merge` ëŠ” ë¶€ëª¨-ìì‹ì˜ ê´€ê³„ë¡œ ë™ì  ë³‘í•©ì´ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. json íŒŒì¼ë¡œ ì˜ˆë¥¼ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

```json
{
  "schoolList" : [
    {
      "name" : "íŠ¹ëª©ê³ ",
      "groupList" : [
        {
          "name" : "ê³¼í•™",
          "nameList" : [
            {
              "name" : "ê°•ë°”ì˜",
              "score" : 54
            },
            {
              "name" : "ìœ¤ì‚¬ì€",
              "score" : 65
            },
            {
              "name" : "ì¥ì•„ë¦°",
              "score" : 98
            },
            {
              "name" : "í•œììœ¤",
              "score" : 69
            },
            {
              "name" : "ë°°ì°¬ì˜",
              "score" : 80
            }
          ]
        },
        {
          "name" : "ì™¸êµ­ì–´",
          "nameList" : [
            {
              "name" : "ì˜¤íƒœí˜„",
              "score" : 79
            },
            {
              "name" : "ê¹€íŒŒì€",
              "score" : 88
            },
            {
              "name" : "ì´í•˜ë¦°",
              "score" : 89
            },
            {
              "name" : "ë°•ê±´ìš°",
              "score" : 38
            },
            {
              "name" : "ìµœê²½ë¯¼",
              "score" : 78
            }
          ]
        },
        {
          "name" : "êµ­ì œ",
          "nameList" : [
            {
              "name" : "ê¹€ë‘ë¦¬",
              "score" : 77
            },
            {
              "name" : "ì´ë¯¸ì£¼",
              "score" : 78
            },
            {
              "name" : "ë°•ë°”ë‹¤",
              "score" : 99
            },
            {
              "name" : "ì¥ì„œì—°",
              "score" : 18
            },
            {
              "name" : "ê¹€ìˆ˜ì•„",
              "score" : 98
            }
          ]
        }
      ]
    }
  ]
}
```
ìœ„ json íŒŒì¼ì˜ ê²½ìš° ìì‹ í•­ëª©ì˜ ê°¯ìˆ˜ ë§Œí¼ ë³‘í•© ì‹œì¼œì•¼ í•˜ê³  ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜µë‹ˆë‹¤.

<br>

![jxls-each-merge-example1](/assets/img/jxls-each-merge-example1.png){:style="border:1px solid #eaeaea; border-radius: 7px; padding: 0px;" }

<br>


<h2> each-merge Template </h2>
---
each-merge í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œ í…œí”Œë¦¿ê³¼ í•¨ìˆ˜ì…ë‹ˆë‹¤.

<br>

![jxls-each-merge-example2](/assets/img/jxls-each-merge-example2.png){:style="border:1px solid #eaeaea; border-radius: 7px; padding: 0px;" }

1. jx:area(lastCell="Z999") ëŠ” Z:999 ì˜ ë²”ìœ„ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.
2. jx:each-merge(items="schools" var="school" lastCell="D3") ëŠ” schools ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë³µí•  ê²ƒì´ë©°, ë¦¬ìŠ¤íŠ¸ ë‚´ì˜ ìì‹ì€ school ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  A:3 ë¶€í„° D:3 ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.
3. 2ë²ˆê³¼ ë§ˆì°¬ê°€ì§€ë¡œ schoolì˜ groupList ë¥¼ ë°˜ë³µí•  ê²ƒì´ë©°, ë¦¬ìŠ¤íŠ¸ ë‚´ì˜ ìì‹ì€ group ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  B:3 ë¶€í„° D:3 ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.
4. groupì˜ nameList ë¥¼ ë°˜ë³µí•  ê²ƒì´ë©°, ë¦¬ìŠ¤íŠ¸ ë‚´ì˜ ìì‹ì€ name ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  C:3 ë¶€í„° D:3 ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.

>ğŸ’¡ A:3 ë¶€í„° D:3 ê¹Œì§€ ì…€ì— ì‘ì„±ë˜ì–´ ìˆëŠ” ${school.name} ì˜ í˜•íƒœëŠ” ìì‹ ê°ì²´(school)ê°€ ê°–ê³ ìˆëŠ” í•­ëª© ì¤‘ nameì„ ë°˜ë³µí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

<br>

<h2> each-merge êµ¬í˜„ </h2>
---

<h3> EachMergeCommand </h3>

```java
public class EachMergeCommand extends EachCommand {

    public static final String COMMAND_NAME = "each-merge";

    @Override
    public Size applyAt(CellRef cellRef, Context context) {


        // each-merge ì…€ ì˜ í•˜ìœ„ ì…€ ì˜ì—­ ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤.
        List<Area> childAreas = this.getAreaList().stream()
                .flatMap(area -> area.getCommandDataList().stream())
                .flatMap(commandData -> commandData.getCommand().getAreaList().stream())
                .collect(Collectors.toList());

        // ì…€ ë³‘í•©ì„ ìˆ˜í–‰í•˜ëŠ” MergeAreaListener instance ìƒì„±
        MergeAreaListener listener = new MergeAreaListener(this.getTransformer(), cellRef);

        // each-merge comment ê°€ ì‘ì„±ëœ cell area ì— MergeAreaListener ì¶”ê°€
        this.getAreaList().get(0).addAreaListener(listener);

        //  í•˜ìœ„ ì˜ì—­ì— MergeAreaListener ì¶”ê°€
        childAreas.forEach(childArea -> {
            childArea.addAreaListener(listener);
        });

        // each ì»¤ë§¨ë“œ ìˆ˜í–‰
        return super.applyAt(cellRef, context);
    }
}
```
ì—‘ì…€ ë‚´ì— each-merge í•¨ìˆ˜ê°€ ìˆëŠ” ê²½ìš° ì‚¬ìš©í•˜ë©°, í•œë²ˆì˜ each-merge ë¥¼ ì§„í–‰í•  ë•Œë§ˆë‹¤ MergeAreaListener ìƒì„±ìë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

<br>

<h3> MergeAreaListener </h3>

```java
public class MergeAreaListener implements AreaListener {

    private final CellRef commandCell;

    private final Sheet sheet;

    private CellRef lastRowCellRef;

    public MergeAreaListener(Transformer transformer, CellRef cellRef) {
        this.commandCell = cellRef;
        this.sheet = ((PoiTransformer) transformer).getXSSFWorkbook().getSheet(cellRef.getSheetName());
    }


    @Override
    public void afterApplyAtCell(CellRef cellRef, Context context) {
        // child cell
        if (commandCell.getCol() != cellRef.getCol()) {
            this.setLastRowCellRef(cellRef);
        } else {
            if (existMerged(cellRef)) {
                return;
            }
            merge(cellRef);
        }
    }

    private void merge(CellRef cellRef) {
        if(this.lastRowCellRef == null) return;

        int from = cellRef.getRow();

        int lastRow = sheet.getMergedRegions().stream()
                .filter(address -> address.isInRange(this.lastRowCellRef.getRow(), this.lastRowCellRef.getCol()))
                .mapToInt(CellRangeAddressBase::getLastRow).findFirst().orElse(this.lastRowCellRef.getRow());

        log.debug("this :{}, merged start row : {} | end row : {} | col :{} ", this.toString(), from, lastRow, cellRef.getCol());

        CellRangeAddress region = new CellRangeAddress(from, lastRow, cellRef.getCol(), cellRef.getCol());
        sheet.addMergedRegion(region);
        applyStyle(sheet.getRow(cellRef.getRow()).getCell(cellRef.getCol()));
    }

    private void setLastRowCellRef(CellRef cellRef) {
        if (this.lastRowCellRef == null || this.lastRowCellRef.getRow() < cellRef.getRow()) {
            this.lastRowCellRef = cellRef;
        }
    }

    private void applyStyle(Cell cell) {
        CellStyle cellStyle = cell.getCellStyle();

        cellStyle.setAlignment(HorizontalAlignment.CENTER);
        cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);
    }

    @Override
    public void beforeApplyAtCell(CellRef cellRef, Context context) {
    }

    @Override
    public void beforeTransformCell(CellRef srcCell, CellRef targetCell, Context context) {
    }

    @Override
    public void afterTransformCell(CellRef srcCell, CellRef targetCell, Context context) {
    }

    private boolean existMerged(CellRef cell) {
        return sheet.getMergedRegions().stream()
                .anyMatch(address -> address.isInRange(cell.getRow(), cell.getCol()));
    }

}
```
ì‹¤ì œ ë³‘í•©ì´ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜ êµ¬í˜„ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. AreaListener ë¥¼ ìƒì†ë°›ì•„ afterApplyAtCell ì„ ì¬ì •ì˜ í–ˆìŠµë‹ˆë‹¤.\
ìì‹ì˜ í•­ëª© ê°¯ìˆ˜ë§Œí¼ ë°˜ë³µí•˜ë©° ì²« ë²ˆì§¸ ì…€ë¶€í„° ë§ˆì§€ë§‰ ì…€ê¹Œì§€ ë³‘í•©ì„ ì§„í–‰í•©ë‹ˆë‹¤.

<br>

<h1> each-merge-single </h1>
---
`each-merge-single` ëŠ” ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ê°€ ë™ì ìœ¼ë¡œ ë³‘í•©ì´ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. json íŒŒì¼ë¡œ ì˜ˆë¥¼ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

```json
{
  "passList" : [
    {
      "name" : "ë¶ˆí•©ê²©"
    },
    {
      "name" : "ë¶ˆí•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "ë¶ˆí•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "ë¶ˆí•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    },
    {
      "name" : "ë¶ˆí•©ê²©"
    },
    {
      "name" : "í•©ê²©"
    }
  ]
}
```
ìœ„ json íŒŒì¼ì˜ ê²½ìš° í•˜ë‚˜ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ ì¤‘ë³µë˜ëŠ” ë¬¸ìë§ˆë‹¤ ë³‘í•© ì‹œì¼œì•¼ í•˜ê³  ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜µë‹ˆë‹¤.

<br>

![jxls-each-merge-single-example1](/assets/img/jxls-each-merge-single-example1.png){:style="border:1px solid #eaeaea; border-radius: 7px; padding: 0px;" }

<br>


<h2> each-merge-single Template </h2>
---
each-merge-single í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œ í…œí”Œë¦¿ê³¼ í•¨ìˆ˜ì…ë‹ˆë‹¤.

<br>

![jxls-each-merge-single-example2](/assets/img/jxls-each-merge-single-example2.png){:style="border:1px solid #eaeaea; border-radius: 7px; padding: 0px;" }

1. jx:area(lastCell="Z999") ëŠ” Z:999 ì˜ ë²”ìœ„ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.
2. jx:each-merge-single(items="passes" var="pass" lastCell="A3") ëŠ” passes ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë³µí•  ê²ƒì´ë©°, ë¦¬ìŠ¤íŠ¸ ë‚´ì˜ ìì‹ì€ pass ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  A:3 ê¹Œì§€ í…œí”Œë¦¿ì˜ ì˜ì—­ ì´ë¼ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.
3. varIndex ëŠ” ë°˜ë³µ ìƒ‰ì¸ì„ ë³´ìœ í•˜ëŠ” Jxls contextì˜ ë³€ìˆ˜ ëª…ì´ë©° 0ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤. (ë°˜ë³µ ì‹œ í˜„ì¬ indexë¥¼ ì•Œê¸° ìœ„í•´ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤)

> ğŸ’¡ A:3 ì— ì‘ì„±ë˜ì–´ ìˆëŠ” ${pass.name} ì˜ í˜•íƒœëŠ” ê°ì²´(pass)ê°€ ê°–ê³ ìˆëŠ” í•­ëª© ì¤‘ nameì„ ë°˜ë³µí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

<br>

<h2> each-merge-single êµ¬í˜„ </h2>
---

<h3> EachMergeSingleCommand </h3>

```java
public class EachMergeSingleCommand extends EachCommand {

    public static final String COMMAND_NAME = "each-merge-single";

    @Override
    public Size applyAt(CellRef cellRef, Context context) {
        // each-merge ì…€ ì˜ í•˜ìœ„ ì…€ ì˜ì—­ ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤.
        List<Area> childAreas = this.getAreaList().stream()
                .flatMap(area -> area.getCommandDataList().stream())
                .flatMap(commandData -> commandData.getCommand().getAreaList().stream())
                .collect(Collectors.toList());

        // ì…€ ë³‘í•©ì„ ìˆ˜í–‰í•˜ëŠ” MergeAreaListener instance ìƒì„±
        MergeAreaSingleListener listener = new MergeAreaSingleListener(this.getTransformer(), cellRef, this.getItems());

        // each-merge comment ê°€ ì‘ì„±ëœ cell area ì— MergeAreaListener ì¶”ê°€
        this.getAreaList().get(0).addAreaListener(listener);

        //  í•˜ìœ„ ì˜ì—­ì— MergeAreaListener ì¶”ê°€
        childAreas.forEach(childArea -> {
            childArea.addAreaListener(listener);
        });

        // each ì»¤ë§¨ë“œ ìˆ˜í–‰
        return super.applyAt(cellRef, context);
    }
}
```
ì—‘ì…€ ë‚´ì— each-merge-single í•¨ìˆ˜ê°€ ìˆëŠ” ê²½ìš° ì‚¬ìš©í•˜ë©°, í•œë²ˆì˜ each-merge-single ë¥¼ ì§„í–‰í•  ë•Œë§ˆë‹¤ MergeAreaSingleListener ìƒì„±ìë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

<br>

<h3> MergeAreaSingleListener </h3>

```java
public class MergeAreaSingleListener implements AreaListener {

    private final CellRef commandCell;

    private final Sheet sheet;

    private final String item;

    private CellRef lastRowCellRef;

    private XSSFWorkbook workbook;

    public MergeAreaSingleListener(Transformer transformer, CellRef cellRef, String item) {
        this.commandCell = cellRef;
        this.workbook = ((PoiTransformer) transformer).getXSSFWorkbook();
        this.sheet = workbook.getSheet(cellRef.getSheetName());
        this.item = item;
    }


    @Override
    public void afterApplyAtCell(CellRef cellRef, Context context) {

        List<String> object = (List<String>) context.getVar(item);
        int totalSize = object.size();
        int curSize = (int) context.getVar("index");

        if(curSize + 1 == totalSize || !Objects.equals(object.get(curSize), object.get(curSize + 1))) {
            merge(cellRef);
        }else{
            return;
        }

    }

    private void merge(CellRef cellRef) {
        // ë³‘í•©ì´ ì‹œì‘ë  ì§€ì 
        int from = this.lastRowCellRef == null ? commandCell.getRow() : this.lastRowCellRef.getRow() + 1;
        int lastRow = cellRef.getRow();

        this.setLastRowCellRef(cellRef);

        log.debug("this :{}, merged start row : {} | end row : {} | col :{} ", this.toString(), from, lastRow, cellRef.getCol());

        if(from != lastRow) {
            // ë³‘í•© cell ìƒì„±
            CellRangeAddress region = new CellRangeAddress(from, lastRow, cellRef.getCol(), cellRef.getCol());

            // sheet ì— ë³‘í•©ëœ ì…€ ì¶”ê°€
            sheet.addMergedRegion(region);
        }

        // ìŠ¤íƒ€ì¼ ì ìš©
        applyStyle(sheet.getRow(from).getCell(cellRef.getCol()));
    }

    private void setLastRowCellRef(CellRef cellRef) {
        if (this.lastRowCellRef == null || this.lastRowCellRef.getRow() < cellRef.getRow()) {
            this.lastRowCellRef = cellRef;
        }
    }

    private void applyStyle(Cell cell) {
        CellStyle cellStyle = null;
        Font font = workbook.createFont();
        font.setColor(IndexedColors.WHITE.getIndex());

        // ë°°ê²½, í°íŠ¸ ì§€ì •
        if(cell.toString().equals("ë¶ˆí•©ê²©")) {
            cellStyle = workbook.createCellStyle();
            cellStyle.setFont(font);
            cellStyle.setFillForegroundColor(IndexedColors.RED.getIndex());
            cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        }else if(cell.toString().equals("í•©ê²©")) {
            cellStyle = workbook.createCellStyle();
            cellStyle.setFont(font);
            cellStyle.setFillForegroundColor(IndexedColors.GREEN.getIndex());
            cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        }else{
            cellStyle = cell.getCellStyle();
        }

        cellStyle.setAlignment(HorizontalAlignment.CENTER);
        cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);
        cell.setCellStyle(cellStyle);
    }


    private boolean existMerged(CellRef cell) {
        return sheet.getMergedRegions().stream()
                .anyMatch(address -> address.isInRange(cell.getRow(), cell.getCol()));
    }

    @Override
    public void beforeApplyAtCell(CellRef cellRef, Context context) {
    }

    @Override
    public void beforeTransformCell(CellRef srcCell, CellRef targetCell, Context context) {
    }

    @Override
    public void afterTransformCell(CellRef srcCell, CellRef targetCell, Context context) {
    }

}
```
ì‹¤ì œ ë³‘í•©ì´ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜ êµ¬í˜„ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. AreaListener ë¥¼ ìƒì†ë°›ì•„ afterApplyAtCell ì„ ì¬ì •ì˜ í–ˆìŠµë‹ˆë‹¤.\
í•­ëª© ê°¯ìˆ˜ë§Œí¼ ë°˜ë³µí•˜ë©° ë‹¤ìŒ í•­ëª©ê³¼ ë‹¤ë¥¸ ë¬¸ìì—´ì„ ê°€ì§„ ê²½ìš° ë³‘í•©ì„ ì§„í–‰í•©ë‹ˆë‹¤.\
`ë¶ˆí•©ê²©`ì¸ ê²½ìš° ì™€ `í•©ê²©`ì¸ ê²½ìš° í°íŠ¸ ìƒ‰ìƒê³¼ ë°°ê²½ìƒ‰ì„ ë³€ê²½í•©ë‹ˆë‹¤.

<br>

<h1> ì°¸ì¡° </h1>
---
- [jxls-docs](https://jxls.sourceforge.net/)
- [samhyun-blog](https://samhyun-blog.netlify.app/posts/jxls_jxls-custom-command/)

<br>

<h1> Repository </h1>
---
- [jxls-merge](https://github.com/gun1507/jxls-merge)